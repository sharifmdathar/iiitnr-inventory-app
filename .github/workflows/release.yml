name: Release APK and Desktop Installers

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name for release (optional, defaults to event tag)"
        required: false
        type: string

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 1

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654
        with:
          distribution: temurin
          java-version: 21
          cache: "gradle"

      - name: Decode release keystore
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$RELEASE_KEYSTORE_BASE64" ]; then
            mkdir -p app/android
            echo "$RELEASE_KEYSTORE_BASE64" | base64 -d > app/android/app-release.jks
          fi

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@f236b35da9d031e13b1005234ebe4392ed54c580

      - name: Build Android release APK
        working-directory: app
        env:
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          chmod +x ./gradlew
          if [ -n "$RELEASE_KEYSTORE_BASE64" ] && [ -f "android/app-release.jks" ]; then
            export RELEASE_KEYSTORE_PATH="app-release.jks"
          fi
          ./gradlew :android:assembleRelease --parallel --build-cache

      - name: Upload APK artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: android-release-apk
          path: app/android/build/outputs/apk/release/android-release.apk
          retention-days: 1

  build-windows-installers:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 1

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654
        with:
          distribution: temurin
          java-version: 21
          cache: "gradle"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@f236b35da9d031e13b1005234ebe4392ed54c580

      - name: Build Desktop installers (EXE + MSI)
        working-directory: app
        env:
          GOOGLE_DESKTOP_CLIENT_ID: ${{ secrets.GOOGLE_DESKTOP_CLIENT_ID }}
          GOOGLE_DESKTOP_CLIENT_SECRET: ${{ secrets.GOOGLE_DESKTOP_CLIENT_SECRET }}
          GOOGLE_DESKTOP_REDIRECT_URI: ${{ secrets.GOOGLE_DESKTOP_REDIRECT_URI }}
        run: |
          .\gradlew.bat :desktop:packageExe -PbuildInstallers=true --parallel --build-cache
          .\gradlew.bat :desktop:packageMsi -PbuildInstallers=true --parallel --build-cache

      - name: Locate and copy EXE + MSI
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          $exe = Get-ChildItem -Path app\desktop\build\compose -Recurse -Filter "*.exe" -ErrorAction Stop | Select-Object -First 1
          $msi = Get-ChildItem -Path app\desktop\build\compose -Recurse -Filter "*.msi" -ErrorAction Stop | Select-Object -First 1
          Copy-Item $exe.FullName -Destination "$env:GITHUB_WORKSPACE\IIITNR-Inventory-App.exe"
          Copy-Item $msi.FullName -Destination "$env:GITHUB_WORKSPACE\IIITNR-Inventory-App.msi"

      - name: Upload EXE artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: desktop-release-exe
          path: IIITNR-Inventory-App.exe
          retention-days: 1

      - name: Upload MSI artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: desktop-release-msi
          path: IIITNR-Inventory-App.msi
          retention-days: 1

  build-linux-appimage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 1

      - name: Set up JDK 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654
        with:
          distribution: temurin
          java-version: 21
          cache: "gradle"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@f236b35da9d031e13b1005234ebe4392ed54c580

      - name: Build Desktop app-image (Linux)
        working-directory: app
        env:
          GOOGLE_DESKTOP_CLIENT_ID: ${{ secrets.GOOGLE_DESKTOP_CLIENT_ID }}
          GOOGLE_DESKTOP_CLIENT_SECRET: ${{ secrets.GOOGLE_DESKTOP_CLIENT_SECRET }}
          GOOGLE_DESKTOP_REDIRECT_URI: ${{ secrets.GOOGLE_DESKTOP_REDIRECT_URI }}
        run: |
          chmod +x ./gradlew
          ./gradlew :desktop:packageDistributionForCurrentOS --parallel --build-cache

      - name: Install ImageMagick and libfuse2 (for AppImage)
        run: sudo apt-get update && sudo apt-get install -y imagemagick libfuse2

      - name: Prepare AppDir for AppImage
        run: |
          APP_SRC="app/desktop/build/compose/binaries/main/app/IIITNR Inventory App"
          APPDIR="$RUNNER_TEMP/AppDir"
          mkdir -p "$APPDIR"
          cp -a "$APP_SRC"/* "$APPDIR/"
          cat > "$APPDIR/AppRun" << 'APPRUN'
          #!/bin/bash
          SELF="$(readlink -f "$0")"
          DIR="$(dirname "$SELF")"
          exec "$DIR/bin/IIITNR Inventory App" "$@"
          APPRUN
          chmod +x "$APPDIR/AppRun"
          cat > "$APPDIR/iiitnr-inventory-app.desktop" << 'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=IIITNR Inventory App
          Exec=AppRun
          Icon=iiitnr-inventory-app
          Categories=Utility;
          DESKTOP
          convert -size 256x256 xc:'#1976D2' "$APPDIR/iiitnr-inventory-app.png"
          echo "APPDIR=$APPDIR" >> $GITHUB_ENV

      - name: Download appimagetool
        run: |
          curl -sL "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -o appimagetool.AppImage
          chmod +x appimagetool.AppImage

      - name: Build AppImage
        run: |
          ./appimagetool.AppImage "$APPDIR" IIITNR-Inventory-App.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: linux-appimage-release
          path: IIITNR-Inventory-App.AppImage
          retention-days: 1

  upload-release:
    needs: [build-android, build-windows-installers, build-linux-appimage]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          path: artifacts

      - name: Determine tag name
        id: tag
        env:
          INPUT_TAG_NAME: ${{ github.event.inputs.tag_name }}
          RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          TAG_NAME="${INPUT_TAG_NAME:-${RELEASE_TAG_NAME:-$REF_NAME}}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG_NAME"

      - name: Upload release assets
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          files: |
            artifacts/android-release-apk/android-release.apk
            artifacts/desktop-release-exe/IIITNR-Inventory-App.exe
            artifacts/desktop-release-msi/IIITNR-Inventory-App.msi
            artifacts/linux-appimage-release/IIITNR-Inventory-App.AppImage
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
