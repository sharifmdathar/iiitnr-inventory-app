name: Release APK and EXE

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 25
          cache: gradle

      - name: Decode release keystore
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          if ($env:RELEASE_KEYSTORE_BASE64) {
            $bytes = [System.Convert]::FromBase64String($env:RELEASE_KEYSTORE_BASE64)
            New-Item -ItemType Directory -Force -Path app\android | Out-Null
            [System.IO.File]::WriteAllBytes("${{ github.workspace }}\app\android\app-release.jks", $bytes)
          } else {
            Write-Host "RELEASE_KEYSTORE_BASE64 not set; APK will be signed with debug key"
          }

      - name: Build Android release APK
        working-directory: app
        env:
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          $gradleArgs = ":android:assembleRelease"
          if (Test-Path "android\app-release.jks") {
            $gradleArgs += " -PRELEASE_KEYSTORE_PATH=android/app-release.jks -PRELEASE_STORE_PASSWORD=$env:RELEASE_STORE_PASSWORD -PRELEASE_KEY_ALIAS=$env:RELEASE_KEY_ALIAS -PRELEASE_KEY_PASSWORD=$env:RELEASE_KEY_PASSWORD"
          }
          .\gradlew.bat $gradleArgs

      - name: Build Desktop EXE
        working-directory: app
        run: .\gradlew.bat :desktop:packageExe -PbuildInstallers=true

      - name: Locate and copy EXE
        run: |
          $exe = Get-ChildItem -Path app\desktop\build\compose -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $exe) { Write-Error "No EXE found under app/desktop/build/compose" }
          Copy-Item $exe.FullName -Destination "${{ github.workspace }}\IIITNR-Inventory-App.exe"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            app/android/build/outputs/apk/release/android-release.apk
            IIITNR-Inventory-App.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
